<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTLock Helper UI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <style>
        body { padding: 20px; }
        pre {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .card-header {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">

    <h1 class="mb-4">TTLock Helper – Web UI</h1>
    <p class="text-muted">
        This interface helps you register TTLock users, get access tokens,
        generate access codes, and control locks.  
        It also provides an API endpoint for Home Assistant.
    </p>

    <!-- ============================================================= -->
    <!-- SHORTCUT SECTION -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Shortcut – Already have username, password, and access token?</div>
        <div class="card-body">
            <p>
                If you already created a TTLock user (e.g. from another tool or previous setup),
                you can paste your credentials here and jump straight to:
                <strong>Step 5 (Fetch Locks)</strong> and
                <strong>Step 6 (Control Locks)</strong>.
            </p>

            <form method="post" action="/fast_setup" class="row g-3">

                <div class="col-md-4">
                    <label class="form-label">API Base URL</label>
                    <input type="text" class="form-control"
                           name="fast_api_base_url"
                           value="{{ cfg.api_base_url }}">
                    <div class="form-text">
                        Usually <code>https://api.ttlock.com</code>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Full TTLock Username</label>
                    <input type="text" class="form-control"
                           name="fast_username"
                           value="{{ cfg.username }}">
                    <div class="form-text">
                        Example: <code>xyz123_lockuser</code> (your TTLock-assigned username)
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Plain Password (optional)</label>
                    <input type="password" class="form-control"
                           name="fast_plain_password">
                    <div class="form-text">
                        If set, MD5 will be auto-generated.
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Password (MD5)</label>
                    <input type="text" class="form-control"
                           name="fast_password_md5"
                           value="{{ cfg.password_md5 }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Access Token</label>
                    <input type="text" class="form-control"
                           name="fast_access_token"
                           value="{{ cfg.access_token }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Refresh Token</label>
                    <input type="text" class="form-control"
                           name="fast_refresh_token"
                           value="{{ cfg.refresh_token }}">
                </div>

                <div class="col-md-12">
                    <button type="submit" class="btn btn-success">
                        Verify & Save → Jump to Step 5
                    </button>
                </div>
            </form>

            {% if register_error %}
            <div class="alert alert-info mt-3">
                {{ register_error }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 1: CREATE USERNAME + PASSWORD -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 1 – Create TTLock Username + Password</div>
        <div class="card-body">

            <form method="post" action="/hash_password" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Desired Username</label>
                    <input type="text" class="form-control"
                           name="username"
                           value="{{ cfg.username }}">
                    <div class="form-text">
                        Letters + numbers only. No spaces/underscores.
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Plain Password</label>
                    <input type="password" class="form-control"
                           name="plain_password">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Password (MD5)</label>
                    <input type="text" readonly
                           class="form-control"
                           value="{{ hashed_password }}">
                </div>

                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary">
                        Generate MD5 Hash + Current Timestamp
                    </button>
                </div>
            </form>

            <hr>

            <p><strong>Generated Timestamp:</strong> {{ cfg.last_date_ms }}</p>

            {% if hashed_password %}
            <p><strong>Generated MD5 Password:</strong> {{ hashed_password }}</p>
            {% endif %}

        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 2: SAVE SETTINGS -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 2 – Configure API Credentials</div>
        <div class="card-body">

            <form method="post" action="/save_settings" class="row g-3">

                <div class="col-md-4">
                    <label class="form-label">API Base URL</label>
                    <input type="text" class="form-control"
                           name="api_base_url"
                           value="{{ cfg.api_base_url }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Redirect URI</label>
                    <input type="text" class="form-control"
                           name="redirect_uri"
                           value="{{ cfg.redirect_uri }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Client ID</label>
                    <input type="text" class="form-control"
                           name="client_id"
                           value="{{ cfg.client_id }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Client Secret</label>
                    <input type="text" class="form-control"
                           name="client_secret"
                           value="{{ cfg.client_secret }}">
                </div>

                <div class="col-md-12">
                    <button type="submit" class="btn btn-secondary">
                        Save Settings
                    </button>
                </div>

            </form>

        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 3: REGISTER USER -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 3 – Register TTLock User</div>

        <div class="card-body">
            <form method="post" action="/register_user">
                <button class="btn btn-warning">Register User</button>
            </form>

            {% if register_error %}
            <div class="alert alert-danger mt-3">{{ register_error }}</div>
            {% endif %}

            {% if cfg.raw_register_response %}
            <h6>Raw API Response:</h6>
            <pre>{{ cfg.raw_register_response }}</pre>
            {% endif %}

            {% if curl_register_example %}
            <h6>Equivalent curl command:</h6>
            <pre>{{ curl_register_example }}</pre>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 4: GET TOKEN -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 4 – Get Access Token</div>

        <div class="card-body">
            <form method="post" action="/get_token">
                <button class="btn btn-info">Request Token</button>
            </form>

            {% if token_error %}
            <div class="alert alert-danger mt-3">{{ token_error }}</div>
            {% endif %}

            {% if cfg.raw_token_response %}
            <pre>{{ cfg.raw_token_response }}</pre>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 5: FETCH LOCK LIST -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 5 – Fetch Locks From TTLock</div>

        <div class="card-body">
            <form method="post" action="/fetch_locks">
                <button class="btn btn-success">Fetch Lock List</button>
            </form>

            {% if cfg.last_lock_error %}
            <div class="alert alert-danger mt-3">{{ cfg.last_lock_error }}</div>
            {% endif %}

            {% if cfg.locks %}
            <h5 class="mt-3">Locks:</h5>
            <pre>{{ cfg.locks | tojson }}</pre>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- STEP 6: LOCK / UNLOCK CONTROL -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Step 6 – Control Locks</div>

        <div class="card-body">
            {% if cfg.locks %}
            <form method="post" action="/control_lock" class="row g-3">

                <div class="col-md-6">
                    <label class="form-label">Select Lock</label>
                    <select class="form-control" name="lock_id">
                        {% for lock in cfg.locks %}
                        <option value="{{ lock.lockId }}">
                            {{ lock.lockAlias }} (ID {{ lock.lockId }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Action</label>
                    <select name="action" class="form-control">
                        <option value="lock">Lock</option>
                        <option value="unlock">Unlock</option>
                    </select>
                </div>

                <div class="col-md-12">
                    <button class="btn btn-primary">Send Command</button>
                </div>

            </form>

            {% if cfg.last_lock_action_result %}
            <h6 class="mt-3">API Response:</h6>
            <pre>{{ cfg.last_lock_action_result }}</pre>
            {% endif %}

            {% else %}
            <p class="text-muted">No locks loaded. Fetch them in Step 5.</p>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- LOG OUTPUT -->
    <!-- ============================================================= -->
    <div class="card mb-4">
        <div class="card-header">Log Output (Latest)</div>
        <div class="card-body">
            <pre>{{ log_tail }}</pre>
        </div>
    </div>

</div>

</body>
</html>
