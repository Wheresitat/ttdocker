  <!-- STEP 5: Fetch locks -->
  <div class="card mb-4">
    <div class="card-header fw-bold">
      Step 5 – Fetch locks from TTLock
    </div>
    <div class="card-body">
      <p>
        Once you have an access token (Step 4), use this step to fetch all locks on the account.
      </p>
      <form method="post" action="/fetch_locks">
        <button type="submit" class="btn btn-info">Fetch locks</button>
      </form>

      {% if cfg.locks %}
        <div class="mt-3">
          <label class="form-label">Discovered locks</label>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Lock ID</th>
                  <th>Name</th>
                  <th>Battery</th>
                  <th>Raw</th>
                </tr>
              </thead>
              <tbody>
                {% for lock in cfg.locks %}
                  <tr>
                    <td>{{ lock.lockId or lock["lockId"] }}</td>
                    <td>{{ lock.lockAlias or lock["lockAlias"] }}</td>
                    <td>
                      {% if lock.electricQuantity is defined %}
                        {{ lock.electricQuantity }}%
                      {% elif lock["electricQuantity"] is defined %}
                        {{ lock["electricQuantity"] }}%
                      {% else %}
                        ?
                      {% endif %}
                    </td>
                    <td>
                      <small>{{ lock }}</small>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      {% if cfg.last_lock_error %}
        <div class="alert alert-danger mt-3">{{ cfg.last_lock_error }}</div>
      {% endif %}
    </div>
  </div>

  <!-- STEP 6: Control locks -->
  <div class="card mb-4">
    <div class="card-header fw-bold">
      Step 6 – Control a lock (lock / unlock)
    </div>
    <div class="card-body">
      <p>
        Select a lock and send a lock or unlock command via the TTLock cloud.
      </p>
      <form method="post" action="/control_lock" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Lock</label>
          <select class="form-select" name="lock_id">
            <option value="">-- Select lock --</option>
            {% for lock in cfg.locks %}
              <option value="{{ lock.lockId or lock['lockId'] }}">
                {{ lock.lockAlias or lock['lockAlias'] }} (ID: {{ lock.lockId or lock['lockId'] }})
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-end gap-2">
          <button type="submit" name="action" value="lock" class="btn btn-outline-primary">Lock</button>
          <button type="submit" name="action" value="unlock" class="btn btn-outline-danger">Unlock</button>
        </div>
      </form>

      {% if cfg.last_lock_error %}
        <div class="alert alert-danger mt-3">{{ cfg.last_lock_error }}</div>
      {% endif %}

      {% if cfg.last_lock_action_result %}
        <div class="mt-3">
          <label class="form-label">Last lock action result</label>
          <textarea class="form-control" rows="5" readonly>{{ cfg.last_lock_action_result }}</textarea>
        </div>
      {% endif %}
    </div>
  </div>
